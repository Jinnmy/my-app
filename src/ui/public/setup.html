<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAS Setup Wizard</title>
    <link rel="icon" href="assets/logo.ico" type="image/x-icon">
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .wizard-container {
            width: 100%;
            max-width: 600px;
            background: var(--card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 300;
            letter-spacing: -0.025em;
        }

        .step {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        input,
        select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #334155;
            margin-top: 1rem;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .disk-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .disk-card {
            background: #0f172a;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .disk-card.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .disk-info h3 {
            margin: 0;
            font-size: 1rem;
        }

        .disk-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--card);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-text {
            color: var(--text);
            font-size: 1.25rem;
            margin-top: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="wizard-container">
        <h1>NAS Setup</h1>

        <!-- Step 1: Disk Selection -->
        <div id="step1" class="step active">
            <h2>Select Storage Disks</h2>
            <p class="text-muted">Choose the drives you want to use for storage.</p>
            <div id="diskList" class="disk-list">
                <!-- Disks will be injected here -->
                <div class="disk-card">Loading disks...</div>
            </div>
            <button class="btn" onclick="nextStep(2)" style="margin-top: 1.5rem;">Next</button>
        </div>

        <!-- Step 2: RAID Configuration -->
        <div id="step2" class="step">
            <h2>RAID Configuration</h2>
            <p class="text-muted">Select your data protection level.</p>
            <div class="form-group">
                <label>RAID Level</label>
                <select id="raidLevel">
                    <option value="0">RAID 0 (Striping) - Fast, No Redundancy</option>
                    <option value="1">RAID 1 (Mirroring) - Safe, 50% Capacity</option>
                    <option value="5">RAID 5 (Parity) - Balanced (Requires 3+ disks)</option>
                    <option value="JBOD">JBOD (Just a Bunch of Disks)</option>
                </select>
            </div>
            <button class="btn" onclick="nextStep(3)">Next</button>
            <button class="btn btn-secondary" onclick="nextStep(1)">Back</button>
        </div>

        <!-- Step 3: Admin Account -->
        <div id="step3" class="step">
            <h2>Create Admin Account</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="admin">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            <button class="btn" onclick="nextStep(4)">Next</button>
            <button class="btn btn-secondary" onclick="nextStep(2)">Back</button>
        </div>

        <!-- Step 4: Startup Permission -->
        <div id="step4" class="step">
            <h2>Final Setup</h2>
            <p>Do you want this NAS application to start automatically when Windows starts?</p>
            <div class="form-group">
                <label class="disk-card" style="cursor: pointer;">
                    <input type="checkbox" id="startupCheck" checked style="width: auto; margin-right: 1rem;">
                    <span>Start on Windows Startup</span>
                </label>
            </div>
            <button class="btn" onclick="finishSetup()">Finish Setup</button>
            <button class="btn btn-secondary" onclick="nextStep(3)">Back</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Setting up your NAS...</div>
        </div>
    </div>

    <script>
        let selectedDisks = [];
        let currentStep = 1;
        let isExistingDiskMode = false;

        async function fetchDisks() {
            try {
                const res = await fetch('/api/system/disks');
                const disks = await res.json();
                const container = document.getElementById('diskList');
                container.innerHTML = '';

                let availableCount = 0;

                disks.forEach(disk => {
                    const div = document.createElement('div');
                    div.className = 'disk-card';

                    const isPoolable = disk.canPool;
                    const isBoot = disk.isBoot;

                    if (!isBoot) availableCount++;

                    if (isBoot) {
                        div.style.opacity = '0.5';
                        div.style.cursor = 'not-allowed';
                        div.title = 'System Boot Disk (Cannot be used)';
                    } else {
                        div.onclick = () => toggleDisk(div, disk.device, isPoolable);
                    }

                    let statusHtml = '';
                    if (isBoot) statusHtml = '<span style="color:#f87171">System Disk</span>';
                    else if (isPoolable) statusHtml = '<span style="color:#4ade80">Available</span>';
                    else statusHtml = '<span style="color:#fbbf24">Existing Data</span>';

                    div.innerHTML = `
                    <div class="disk-info">
                        <h3>${disk.name || 'Unknown Disk'} (${disk.device})</h3>
                        <p>Size: ${(disk.size / 1073741824).toFixed(2)} GB | Status: ${statusHtml}</p>
                    </div>
                `;
                    container.appendChild(div);
                });

                if (availableCount === 0) {
                    const warning = document.createElement('div');
                    warning.style.color = '#f87171';
                    warning.style.marginTop = '1rem';
                    warning.innerHTML = 'No available disks found.';
                    container.appendChild(warning);
                }

            } catch (e) {
                console.error(e);
                document.getElementById('diskList').innerHTML = '<p style="color:red">Failed to load disks.</p>';
            }
        }

        function toggleDisk(el, device, isPoolable) {
            // If we are selecting a disk that is NOT poolable (existing data), we enforce single selection
            if (!isPoolable) {
                if (selectedDisks.includes(device)) {
                    selectedDisks = [];
                    el.classList.remove('selected');
                    isExistingDiskMode = false;
                } else {
                    // Deselect all others
                    document.querySelectorAll('.disk-card').forEach(c => c.classList.remove('selected'));
                    selectedDisks = [device];
                    el.classList.add('selected');
                    isExistingDiskMode = true;
                }
            } else {
                // Normal poolable disk selection
                if (isExistingDiskMode) {
                    // If switching from existing mode, clear everything first
                    document.querySelectorAll('.disk-card').forEach(c => c.classList.remove('selected'));
                    selectedDisks = [];
                    isExistingDiskMode = false;
                }

                el.classList.toggle('selected');
                if (selectedDisks.includes(device)) {
                    selectedDisks = selectedDisks.filter(d => d !== device);
                } else {
                    selectedDisks.push(device);
                }
            }
        }

        function nextStep(step) {
            if (step === 2) {
                if (selectedDisks.length === 0) {
                    alert('Please select at least one disk.');
                    return;
                }

                if (isExistingDiskMode) {
                    // Skip RAID setup for existing disks
                    nextStep(3);
                    return;
                }

                updateRaidOptions();
            }
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
        }

        async function finishSetup() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            // If existing mode, use 'existing', otherwise get from select
            const raid = isExistingDiskMode ? 'existing' : document.getElementById('raidLevel').value;
            const startup = document.getElementById('startupCheck').checked;

            if (!username || !email || !password) {
                alert('Please fill in all admin fields');
                nextStep(3);
                return;
            }

            // Validation
            if (username.length < 3) {
                alert('Username must be at least 3 characters long.');
                nextStep(3);
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                nextStep(3);
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters long.');
                nextStep(3);
                return;
            }

            let confirmMsg = "WARNING: This operation will ERASE ALL DATA on the selected disks and create new partitions. This cannot be undone.\n\nAre you sure you want to proceed?";
            if (isExistingDiskMode) {
                confirmMsg = "You have selected to use an existing disk. The application will attempt to use the existing volume on this disk. No data will be erased, but please ensure this is the correct disk.\n\nProceed?";
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Show loading overlay
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                overlay.style.display = 'flex';

                // 1. Save Storage
                loadingText.innerText = 'Configuring Storage (this might take a while)...';
                const storageRes = await fetch('/api/system/storage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ disks: selectedDisks, raidLevel: raid })
                });

                if (!storageRes.ok) {
                    const errData = await storageRes.json();
                    throw new Error(errData.error || 'Failed to configure storage');
                }

                // 2. Create Admin
                loadingText.innerText = 'Creating Admin Account...';
                const userRes = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, role: 'admin' })
                });

                if (!userRes.ok) throw new Error('Failed to create admin');

                // 3. Set Startup
                loadingText.innerText = 'Finalizing Settings...';
                await fetch('/api/system/startup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: startup })
                });

                loadingText.innerText = 'Setup Complete! Redirecting...';
                setTimeout(() => {
                    window.location.href = '/'; // Go to dashboard
                }, 1000);
            } catch (err) {
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error during setup: ' + err.message);
            }
        }

        // Load disks on start
        function updateRaidOptions() {
            const raidSelect = document.getElementById('raidLevel');
            const count = selectedDisks.length;

            Array.from(raidSelect.options).forEach(opt => {
                const val = opt.value;
                let enabled = false;

                if (val === 'JBOD') enabled = count >= 1;
                else if (val === '0') enabled = count >= 2;
                else if (val === '1') enabled = count >= 2;
                else if (val === '5') enabled = count >= 3;

                opt.disabled = !enabled;
                if (!enabled) {
                    if (!opt.innerText.includes('(Unavailable)')) {
                        opt.innerText += ' (Unavailable)';
                    }
                } else {
                    opt.innerText = opt.innerText.replace(' (Unavailable)', '');
                }
            });

            const currentOption = raidSelect.options[raidSelect.selectedIndex];
            if (currentOption && currentOption.disabled) {
                for (let opt of raidSelect.options) {
                    if (!opt.disabled) {
                        raidSelect.value = opt.value;
                        break;
                    }
                }
            }
        }

        // Call fetchDisks immediately as the script is at the end of the body
        fetchDisks();
    </script>

</body>

</html>