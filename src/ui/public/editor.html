<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Editor - NAS 2.0</title>
    <link rel="icon" href="assets/logo.ico" type="image/x-icon">
    <!-- Quill Standard CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .editor-header {
            background-color: #ffffff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        #editor {
            flex: 1;
            border: none;
        }

        .ql-toolbar {
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            border-bottom: 1px solid #eee !important;
        }

        .ql-container {
            border: none !important;
            font-size: 16px;
        }

        #status-indicator {
            margin-right: 15px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>

<body>

    <div class="editor-header">
        <div class="file-info" id="file-name">Loading...</div>
        <div class="editor-actions">
            <span id="status-indicator"></span>
            <button class="btn btn-secondary" onclick="window.close()">Close</button>
            <button class="btn btn-primary" id="btn-save">Save</button>
        </div>
    </div>

    <div class="editor-container">
        <div id="editor"></div>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');
        const token = localStorage.getItem('token');

        if (!token) {
            alert('You must be logged in to edit documents.');
            window.location.href = 'index.html';
        }

        if (!fileId) {
            alert('No file specified.');
            window.close();
        }

        // Initialize Quill
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ]
            }
        });

        const statusIndicator = document.getElementById('status-indicator');
        const fileNameEl = document.getElementById('file-name');
        let socket;
        let isRemoteUpdate = false;

        // Load Content
        async function loadContent() {
            try {
                const res = await fetch(`/api/editor/${fileId}/content`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to load content');
                const data = await res.json();

                fileNameEl.textContent = data.originalName;

                // Set content without triggering 'text-change' for socket
                isRemoteUpdate = true;
                quill.clipboard.dangerouslyPasteHTML(data.html);
                isRemoteUpdate = false; // Reset immediately

                setupSocket();
            } catch (error) {
                console.error(error);
                alert('Error loading document: ' + error.message);
            }
        }

        function setupSocket() {
            socket = io({
                auth: { token: token }
            });

            socket.on('connect', () => {
                console.log('Connected to collaboration server');
                statusIndicator.textContent = 'Connected';
                socket.emit('join-document', fileId);
            });

            socket.on('connect_error', (err) => {
                console.error('Socket error:', err);
                statusIndicator.textContent = 'Connection Error';
            });

            socket.on('receive-changes', (delta) => {
                // Apply changes from other users
                isRemoteUpdate = true;
                quill.updateContents(delta);
                isRemoteUpdate = false;
            });

            // Broadcast changes
            quill.on('text-change', (delta, oldDelta, source) => {
                if (source === 'user' && !isRemoteUpdate) {
                    socket.emit('send-changes', { delta, fileId });
                    statusIndicator.textContent = 'Unsaved changes...';
                }
            });
        }

        // Save Button
        document.getElementById('btn-save').addEventListener('click', async () => {
            statusIndicator.textContent = 'Saving...';
            const html = quill.root.innerHTML;

            try {
                const res = await fetch(`/api/editor/${fileId}/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ html })
                });

                if (res.ok) {
                    statusIndicator.textContent = 'All changes saved';
                    setTimeout(() => { statusIndicator.textContent = 'Connected'; }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                alert('Error saving: ' + error.message);
                statusIndicator.textContent = 'Save Error';
            }
        });

        loadContent();
    </script>

</body>

</html>