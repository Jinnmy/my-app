<div class="page-header">
    <h1>Allocations</h1>
    <div class="header-actions">
        <button id="refreshAllocationsBtn" class="btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Refresh
        </button>
    </div>
</div>

<div class="allocations-container">
    <div class="allocations-toolbar">
        <div class="user-selector">
            <label for="targetUser">Allocate to:</label>
            <select id="targetUser" class="form-select">
                <option value="">Select User...</option>
                <!-- Users will be populated here -->
            </select>
            <button id="allocateBtn" class="btn-primary" disabled>
                Allocate Selected
            </button>
        </div>
        <div class="selection-info" id="selectionInfo">
            0 files selected
        </div>
    </div>

    <div class="allocations-list-header">
        <div class="col-checkbox"><input type="checkbox" id="selectAll"></div>
        <div class="col-name">File Name</div>
        <div class="col-size">Size</div>
        <div class="col-path">Path</div>
        <div class="col-date">Date Detected</div>
    </div>

    <div id="allocationsList" class="allocations-list">
        <!-- List items will be injected here -->
        <div class="loading-state">Loading unmarked files...</div>
    </div>
</div>

<style>
    .allocations-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: calc(100vh - 120px);
    }

    .allocations-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--bg-card);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .user-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .allocations-list {
        flex: 1;
        overflow-y: auto;
        background: var(--bg-card);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .allocations-list-header {
        display: flex;
        padding: 0.75rem 1rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-secondary);
        position: sticky;
        top: 0;
    }

    .allocation-row {
        display: flex;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        align-items: center;
        font-size: 0.875rem;
    }

    .allocation-row:hover {
        background: var(--bg-hover);
    }

    .col-checkbox {
        width: 40px;
    }

    .col-name {
        flex: 2;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .col-size {
        width: 100px;
    }

    .col-path {
        flex: 3;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .col-date {
        width: 150px;
        color: var(--text-secondary);
    }

    .empty-state {
        padding: 3rem;
        text-align: center;
        color: var(--text-secondary);
    }
</style>

<script>
    // Inline script for page-specific logic, or called from app.js
    // We will attach it to window so app.js can call it
    window.initAllocationsPage = async function () {
        const list = document.getElementById('allocationsList');
        const userSelect = document.getElementById('targetUser');
        const allocateBtn = document.getElementById('allocateBtn');
        const selectAll = document.getElementById('selectAll');
        const refreshBtn = document.getElementById('refreshAllocationsBtn');
        const selectionInfo = document.getElementById('selectionInfo');

        let allFiles = [];
        let selectedFiles = new Set();
        let users = [];

        async function loadUsers() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return; // Should be handled by app.js redirect

                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    users = await response.json();
                    userSelect.innerHTML = '<option value="">Select User...</option>';
                    users.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.textContent = u.username || u.email;
                        userSelect.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Failed to load users', e);
            }
        }

        async function loadFiles() {
            list.innerHTML = '<div class="loading-state">Loading unmarked files...</div>';
            selectedFiles.clear();
            updateSelectionUI();

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/files/unmarked', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    allFiles = await response.json();
                    renderList();
                } else {
                    list.innerHTML = '<div class="empty-state">Failed to load files</div>';
                }
            } catch (e) {
                console.error(e);
                list.innerHTML = '<div class="empty-state">Error loading files</div>';
            }
        }

        function renderList() {
            if (allFiles.length === 0) {
                list.innerHTML = '<div class="empty-state">No unmarked files found</div>';
                return;
            }

            list.innerHTML = '';
            // Virtualize if needed, but simple list for now
            allFiles.forEach(file => {
                const row = document.createElement('div');
                row.className = 'allocation-row';

                row.innerHTML = `
                    <div class="col-checkbox"><input type="checkbox" class="file-check" value="${file.id}"></div>
                    <div class="col-name" title="${file.name}">${file.name}</div>
                    <div class="col-size">${formatBytes(file.size)}</div>
                    <div class="col-path" title="${file.path}">${file.path}</div>
                    <div class="col-date">${new Date(file.created_at).toLocaleDateString()}</div>
                `;

                const checkbox = row.querySelector('.file-check');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) selectedFiles.add(file.id);
                    else selectedFiles.delete(file.id);
                    updateSelectionUI();
                });

                list.appendChild(row);
            });
        }

        function updateSelectionUI() {
            selectionInfo.textContent = `${selectedFiles.size} files selected`;
            allocateBtn.disabled = selectedFiles.size === 0 || !userSelect.value;

            // Update selectAll state
            if (allFiles.length > 0 && selectedFiles.size === allFiles.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (selectedFiles.size > 0) {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
        }

        selectAll.addEventListener('change', (e) => {
            const checkboxes = list.querySelectorAll('.file-check');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const id = parseInt(cb.value);
                if (e.target.checked) selectedFiles.add(id);
                else selectedFiles.delete(id);
            });
            updateSelectionUI();
        });

        userSelect.addEventListener('change', updateSelectionUI);

        refreshBtn.addEventListener('click', loadFiles);

        allocateBtn.addEventListener('click', async () => {
            const targetUserId = userSelect.value;
            if (!targetUserId || selectedFiles.size === 0) return;

            if (!confirm(`Allocate ${selectedFiles.size} files to selected user?`)) return;

            allocateBtn.disabled = true;
            allocateBtn.textContent = 'Allocating...';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/files/allocate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        fileIds: Array.from(selectedFiles),
                        targetUserId: targetUserId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadFiles(); // Refresh
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Failed to allocate'));
                }
            } catch (e) {
                alert('Connection error');
                console.error(e);
            } finally {
                allocateBtn.disabled = false;
                allocateBtn.textContent = 'Allocate Selected';
            }
        });

        // Initialize
        await loadUsers();
        await loadFiles();
    };
</script>